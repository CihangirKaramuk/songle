import apiService from '../apiService.js';

let islemKayitlari = [];
let sarkiListesi = [];
let duzenlenenIndex = null;
let siralamaArtan = true;
let seciliIndex = null;
let silinecekIndex = null;
let secilenDeezerSarki = null;

// Global function for Deezer JSONP callback
window.deezerJsonpSonuc = function(response) {
  const sonuclarUl = document.getElementById("deezerSonuclar");
  sonuclarUl.innerHTML = "";
  sonuclarUl.style.display = "block";

  if (!response.data || response.data.length === 0) {
    sonuclarUl.innerHTML = "<div style='padding: 10px; color: #ccc;'>SonuÃ§ bulunamadÄ±</div>";
    return;
  }

  response.data.slice(0, 7).forEach(sarki => {
    if (!sarki.preview) return; // Preview'u olmayan ÅŸarkÄ±larÄ± atla
    
    const div = document.createElement("div");
    div.style.padding = "10px";
    div.style.borderBottom = "1px solid #444";
    div.style.display = "flex";
    div.style.justifyContent = "space-between";
    div.style.alignItems = "center";
    
    div.innerHTML = `
      <div style="flex: 1;">
        <div style="font-weight: bold; color: #fff;">${sarki.artist.name}</div>
        <div style="font-size: 0.9em; color: #aaa;">${sarki.title_short}</div>
      </div>
      <button class="ekle-btn" style="background: #4CAF50; color: white; border: none; border-radius: 4px; padding: 5px 10px; cursor: pointer;">
        SeÃ§
      </button>
    `;
    
    const btn = div.querySelector('.ekle-btn');
    btn.addEventListener('click', () => {
      secilenDeezerSarki = {
        artist: sarki.artist.name,
        title: sarki.title_short,
        preview: sarki.preview
      };
      document.getElementById("sanatciAdi").value = sarki.artist.name;
      document.getElementById("sarkiAdi").value = sarki.title_short;
      
      // Preview'u indir ve sunucuya kaydet
      indirVeKaydet(sarki.preview, `${sarki.artist.name}-${sarki.title_short}.mp3`)
        .then(dosyaYolu => {
          // Gizli bir input alanÄ±na dosya yolunu ekle
          let hiddenInput = document.getElementById('dosyaYoluInput');
          if (!hiddenInput) {
            hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.id = 'dosyaYoluInput';
            hiddenInput.name = 'dosyaYolu';
            document.querySelector('.ekle-formu').appendChild(hiddenInput);
          }
          hiddenInput.value = dosyaYolu;
          showSuccessToast("ÅžarkÄ± baÅŸarÄ±yla indirildi!");
        })
        .catch((error) => {
          console.error('ÅžarkÄ± indirilirken hata oluÅŸtu:', error);
          showGuncelleToast("ÅžarkÄ± indirilirken hata oluÅŸtu!");
        });
      
      sonuclarUl.style.display = "none";
    });
    
    sonuclarUl.appendChild(div);
  });
};

// Deezer'dan ÅŸarkÄ± arama fonksiyonu
async function deezerAra(sorgu) {
  const sonuclarUl = document.getElementById("deezerSonuclar");
  sonuclarUl.innerHTML = "<div style='padding: 10px; color: #ccc;'>AranÄ±yor...</div>";
  sonuclarUl.style.display = "block";
  
  // Ã–nceki script etiketini kaldÄ±r (eÄŸer varsa)
  const eskiScript = document.getElementById('deezerScript');
  if (eskiScript) {
    document.head.removeChild(eskiScript);
  }
  
  // JSONP isteÄŸi iÃ§in yeni script etiketi oluÅŸtur
  const script = document.createElement('script');
  script.id = 'deezerScript';
  script.src = `https://api.deezer.com/search?q=${encodeURIComponent(sorgu)}&output=jsonp&callback=deezerJsonpSonuc`;
  document.head.appendChild(script);
}

// URL'den dosyayÄ± indirip sunucuya kaydet
async function indirVeKaydet(url, dosyaAdi) {
  try {
    // Ã–zel karakterleri temizle ve dosya adÄ±nÄ± gÃ¼venli hale getir
    const guvenliDosyaAdi = dosyaAdi.replace(/[^\w\s.-]/gi, '').replace(/\s+/g, '_');
    const dosyaYolu = `songs/${guvenliDosyaAdi}`;
    
    // Sunucuya dosyayÄ± kaydetmek iÃ§in bir endpoint'e gÃ¶nder
    const response = await fetch('save_audio.php', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        audioUrl: url,
        fileName: guvenliDosyaAdi
      })
    });
    
    const result = await response.json();
    
    if (!response.ok) {
      throw new Error(result.error || 'Dosya kaydedilirken bir hata oluÅŸtu');
    }
    
    return dosyaYolu; // Sadece dosya yolunu dÃ¶ndÃ¼r
  } catch (error) {
    console.error('Dosya indirilirken hata oluÅŸtu:', error);
    throw error;
  }
}

// Toast mesajlarÄ±
function showGuncelleToast(msg) {
  const toast = document.getElementById("guncelleToast");
  const toastMsg = document.getElementById("guncelleToastMsg");
  toastMsg.textContent = msg;
  toast.classList.add("show");
  setTimeout(() => {
    toast.classList.remove("show");
  }, 3000);
}

function showSuccessToast(msg) {
  const toast = document.getElementById("successToast");
  const toastMsg = document.getElementById("successToastMsg");
  toastMsg.textContent = msg;
  toast.classList.add("show");
  setTimeout(() => {
    toast.classList.remove("show");
  }, 3000);
}

function showDeleteToast(msg) {
  const toast = document.getElementById("deleteToast");
  const toastMsg = document.getElementById("deleteToastMsg");
  toastMsg.textContent = msg;
  toast.classList.add("show");
  setTimeout(() => {
    toast.classList.remove("show");
  }, 3000);
}

// ÅžarkÄ± listesini gÃ¼ncelle
async function guncelleListe() {
  try {
    sarkiListesi = await apiService.getSongs();
    const listeDiv = document.getElementById("liste");
    listeDiv.innerHTML = "";

    sarkiListesi.forEach((sarki, index) => {
      const sarkiDiv = document.createElement("div");
      sarkiDiv.className = "sarki-item";
      sarkiDiv.innerHTML = `
        <div class="sarki-bilgi">
          <span class="sarki-ad">${sarki.cevap}</span>
          <span class="sarki-kategori">${sarki.kategori}</span>
        </div>
        <div class="sarki-actions">
          <button class="btn btn-edit" onclick="sarkiDuzenle(${index})">DÃ¼zenle</button>
          <button class="btn btn-delete" onclick="sarkiSil(${index})">Sil</button>
        </div>
      `;
      listeDiv.appendChild(sarkiDiv);
    });
  } catch (error) {
    console.error('Error updating song list:', error);
    showGuncelleToast('ÅžarkÄ± listesi gÃ¼ncellenirken hata oluÅŸtu');
  }
}

async function getKategoriler() {
  try {
    const kategoriler = await apiService.getKategoriler("1");
    const kategorilerDiv = document.getElementById("getKategoriler");
    kategorilerDiv.innerHTML = "";

    kategoriler.forEach(kategori => {
      const kategoriDiv = document.createElement("div");
      kategoriDiv.className = "kategori-item";
      kategoriDiv.innerHTML = `
        <span>${kategori.isim}</span>
      `;
      kategorilerDiv.appendChild(kategoriDiv);
    });
  } catch (error) {
    console.error('Error fetching categories:', error);
    showGuncelleToast('Kategoriler alÄ±namadÄ±');
  }
}

// ÅžarkÄ± ekleme iÅŸlemi
document.getElementById("ekleBtn").addEventListener("click", async () => {
  const sarki = document.getElementById("sarkiAdi").value.trim();
  const kategori = document.getElementById("kategori").value;
  const altKategori = document.getElementById("altKategori").value;
  const mp3File = document.getElementById("mp3File").files[0];
  const deezerFilePath = document.getElementById("dosyaYoluInput")?.value;

  // Dosya kontrolÃ¼
  if (!mp3File && !deezerFilePath) {
    alert("LÃ¼tfen bir ÅŸarkÄ± dosyasÄ± yÃ¼kleyin veya Deezer'dan ÅŸarkÄ± seÃ§in!");
    return;
  }

  if (!sarki || !kategori) {
    alert("LÃ¼tfen tÃ¼m alanlarÄ± doldurun!");
    return;
  }

  const tamKategori = altKategori ? `${kategori}-${altKategori.toLowerCase().replace(' ', '')}` : kategori;
  
  try {
    let dosyaYolu = deezerFilePath;
    
    // EÄŸer dosya yÃ¼klendiyse, onu iÅŸle
    if (mp3File) {
      const formData = new FormData();
      formData.append('audio', mp3File);
      formData.append('fileName', mp3File.name.replace(/[^\w\s.-]/g, '').replace(/\s+/g, '_'));
      
      const response = await fetch('save_audio.php', {
        method: 'POST',
        body: formData
      });
      
      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.error || 'Dosya yÃ¼klenirken bir hata oluÅŸtu');
      }
      
      const result = await response.json();
      dosyaYolu = result.filePath;
    }
    
    const newSong = {
      kategori: tamKategori,
      cevap: sarki,
      sarki: "ðŸŽµ ÅžarkÄ± Ã§alÄ±yor. (" + sarki + ")",
      dosya: dosyaYolu
    };

    await apiService.addSong(newSong);
    showSuccessToast('âœ… ÅžarkÄ± baÅŸarÄ±yla eklendi!');
    
    // Formu temizle
    document.getElementById("sarkiAdi").value = "";
    document.getElementById("kategori").value = "";
    document.getElementById("altKategori").innerHTML = '<option value="">Alt Kategori SeÃ§</option>';
    document.getElementById("mp3File").value = "";
    
    // Listeyi gÃ¼ncelle
    await guncelleListe();
    
  } catch (error) {
    console.error('Hata:', error);
    showGuncelleToast('Hata: ' + error.message);
  }
});

// ÅžarkÄ± silme iÅŸlemi
async function sarkiSil(index) {
  if (!confirm("Bu ÅŸarkÄ±yÄ± silmek istediÄŸinize emin misiniz?")) {
    return;
  }

  try {
    const songId = sarkiListesi[index].id;
    // Burada API'den silme iÅŸlemi yapÄ±lacak
    await apiService.deleteSong(songId);
    // dosyayÄ± sil
    const dosyaYolu = sarkiListesi[index].dosya;
    
    showSuccessToast('ÅžarkÄ± baÅŸarÄ±yla silindi');
    await guncelleListe();
    
    // dosyayÄ± sil
    const response = await fetch("delete_audio.php", {
      method: 'POST',
      body: JSON.stringify({ filePath: dosyaYolu }),
    });
    
    if (!response.success) {
      throw new Error('Dosya silinirken bir hata oluÅŸtu');
    }
    
    showSuccessToast('Dosya baÅŸarÄ±yla silindi');
  } catch (error) {
    console.error('Error deleting song:', error);
    showGuncelleToast('ÅžarkÄ± silinirken bir hata oluÅŸtu');
  }
}

// Alt kategorileri tanÄ±mla
const altKategoriler = {
  turkce: ["Rock", "Pop", "Hip Hop", "KarÄ±ÅŸÄ±k"],
  yabanci: ["Rock", "Pop", "Hip Hop", "KarÄ±ÅŸÄ±k"],
  dizi: ["TÃ¼rkÃ§e", "YabancÄ±"],
  film: ["TÃ¼rkÃ§e", "YabancÄ±"]
};

// Kategori deÄŸiÅŸtiÄŸinde alt kategorileri gÃ¼ncelle
document.getElementById('kategori').addEventListener('change', function() {
  const altKategoriSelect = document.getElementById('altKategori');
  const secilenKategori = this.value;
  
  // Alt kategorileri temizle
  altKategoriSelect.innerHTML = '<option value="">Alt Kategori SeÃ§</option>';
  
  // EÄŸer seÃ§ilen bir kategori varsa, alt kategorileri doldur
  if (secilenKategori && altKategoriler[secilenKategori]) {
    altKategoriSelect.style.display = 'block';
    altKategoriler[secilenKategori].forEach(kategori => {
      const option = document.createElement('option');
      option.value = kategori.toLowerCase();
      option.textContent = kategori;
      altKategoriSelect.appendChild(option);
    });
  } else {
    altKategoriSelect.style.display = 'none';
  }
});

// Dosya yÃ¼kleme iÅŸlemleri
document.getElementById('dosyaYukleBtn').addEventListener('click', () => {
  document.getElementById('mp3File').click();
});

// Sadece ÅŸarkÄ± adÄ±nÄ± doldur, dosyayÄ± form gÃ¶nderimine bÄ±rak
document.getElementById('mp3File').addEventListener('change', (e) => {
  const file = e.target.files[0];
  if (!file) return;
  
  // ÅžarkÄ± adÄ±nÄ± otomatik doldur (uzantÄ±yÄ± kaldÄ±rarak)
  const songName = file.name.replace(/\.mp3$/i, '');
  document.getElementById('sarkiAdi').value = songName;
  
  showSuccessToast('Dosya seÃ§ildi! Åžimdi formu gÃ¶nderebilirsiniz.');
});

// Deezer arama butonuna tÄ±klama olayÄ± ekle
document.getElementById('deezerAraBtn').addEventListener('click', () => {
  const sarkiAdi = prompt('Aramak istediÄŸiniz ÅŸarkÄ± adÄ±nÄ± girin:');
  if (sarkiAdi) {
    deezerAra(sarkiAdi);
  }
});

async function checkLogin() {
  const adminGiris = localStorage.getItem("adminGiris");
  if (!adminGiris) {
    window.location.href = "login.html";
  }
}

function logout() {
  localStorage.removeItem("adminGiris");
  window.location.href = "login.html";
}

document.getElementById("logoutBtn").addEventListener("click", logout);

// Form reset function
function resetForm() {
  document.getElementById("sanatciAdi").value = "";
  document.getElementById("sarkiAdi").value = "";
  document.getElementById("kategori").value = "";
  document.getElementById("altKategori").innerHTML = '<option value="">Alt Kategori SeÃ§ *</option>';
  document.getElementById("altKategori").style.display = "none";
  document.getElementById("mp3File").value = "";
}

// Listen for section changes
const panelSections = document.querySelectorAll('.panel-section');
const observer = new MutationObserver(mutations => {
  mutations.forEach(mutation => {
    if (mutation.attributeName === 'class') {
      resetForm();
    }
  });
});

panelSections.forEach(section => {
  observer.observe(section, { attributes: true });
});

// Add event listeners to menu items
const menuItems = document.querySelectorAll('.menu-item');
menuItems.forEach(item => {
  item.addEventListener('click', () => {
    if (!item.classList.contains('active')) {
      resetForm();
    }
  });
});

// Sayfa yÃ¼klendiÄŸinde listeyi gÃ¼ncelle
document.addEventListener("DOMContentLoaded", async function() {
  await checkLogin();
  await guncelleListe();
  await getKategoriler();
  
  // Kategori deÄŸiÅŸtiÄŸinde alt kategorileri gÃ¼ncelle
  document.getElementById("kategori").addEventListener("change", function() {
    const altKategoriSelect = document.getElementById("altKategori");
    const kategori = this.value;
    
    altKategoriSelect.innerHTML = '<option value="">Alt Kategori SeÃ§</option>';
    
    if (kategori === "turkce" || kategori === "yabanci") {
      const altKategoriler = ["Pop", "Rock", "Hip Hop"];
      altKategoriler.forEach(kategori => {
        const option = document.createElement("option");
        option.value = kategori;  
        option.textContent = kategori;
        altKategoriSelect.appendChild(option);
      });
    } else if (kategori === "dizi" || kategori === "film") {
      const altKategoriler = ["TÃ¼rkÃ§e", "YabancÄ±"];
      altKategoriler.forEach(kategori => {
        const option = document.createElement("option");
        option.value = kategori.toLowerCase();
        option.textContent = kategori;
        altKategoriSelect.appendChild(option);
      });
    }
  });
});

// Global scope'a fonksiyonlarÄ± ekle
window.sarkiSil = sarkiSil;
window.sarkiDuzenle = function(index) {
  // DÃ¼zenleme iÅŸlevselliÄŸi buraya eklenecek
  showGuncelleToast('DÃ¼zenleme Ã¶zelliÄŸi yakÄ±nda eklenecek');
};
